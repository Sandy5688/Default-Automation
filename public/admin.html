<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Media Automation - Admin Dashboard</title>
    <link rel="stylesheet" href="/admin.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="admin-container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2><i class="fas fa-robot"></i> Admin Panel</h2>
                <div class="system-status">
                    <span id="system-mode" class="mode-badge">LIVE</span>
                </div>
            </div>
            <ul class="sidebar-menu">
                <li><a href="#dashboard" class="menu-item active" data-section="dashboard">
                    <i class="fas fa-tachometer-alt"></i> Dashboard
                </a></li>
                <li><a href="#posts" class="menu-item" data-section="posts">
                    <i class="fas fa-list"></i> Post Queue
                </a></li>
                <li><a href="#notifications" class="menu-item" data-section="notifications">
                    <i class="fas fa-bell"></i> Notifications
                </a></li>
                <li><a href="#rewards" class="menu-item" data-section="rewards">
                    <i class="fas fa-gift"></i> Rewards
                </a></li>
                <li><a href="#engagement" class="menu-item" data-section="engagement">
                    <i class="fas fa-heart"></i> Engagement
                </a></li>
                <li><a href="#users" class="menu-item" data-section="users">
                    <i class="fas fa-users"></i> Users
                </a></li>
                <li><a href="#bots" class="menu-item" data-section="bots">
                    <i class="fas fa-robot"></i> Bots
                </a></li>
                <li><a href="#blogs" class="menu-item" data-section="blogs">
                    <i class="fas fa-blog"></i> Blogs
                </a></li>
                <li><a href="#settings" class="menu-item" data-section="settings">
                    <i class="fas fa-cog"></i> Settings
                </a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <header class="top-bar">
                <h1 id="page-title">Dashboard</h1>
                <div class="top-bar-actions">
                    <div class="system-info">
                        <span class="status-indicator" id="supabase-status">游릭</span>
                        <span>Supabase</span>
                    </div>
                    <div class="user-info">
                        <span>Admin User</span>
                        <i class="fas fa-user-circle"></i>
                    </div>
                </div>
            </header>

            <!-- Dashboard Section -->
            <section id="dashboard" class="content-section active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-list"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-posts">0</h3>
                            <p>Total Posts</p>
                            <small id="pending-posts">0 pending</small>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-users">0</h3>
                            <p>Active Users</p>
                            <small id="new-users">0 new today</small>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-heart"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="total-engagement">0</h3>
                            <p>Total Engagement</p>
                            <small id="engagement-growth">+0% today</small>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-gift"></i>
                        </div>
                        <div class="stat-info">
                            <h3 id="rewards-issued">0</h3>
                            <p>Rewards Issued</p>
                            <small id="pending-rewards">0 pending</small>
                        </div>
                    </div>
                </div>

                <div class="dashboard-grid">
                    <div class="dashboard-card">
                        <h3>Platform Performance</h3>
                        <canvas id="platformChart" width="400" height="200"></canvas>
                    </div>
                    <div class="dashboard-card">
                        <h3>Recent Activity</h3>
                        <div id="recent-activity" class="activity-list">
                            <!-- Activity items will be loaded here -->
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <h3>Bot Status</h3>
                        <div class="bot-status-grid" id="bot-status-overview">
                            <!-- Bot status will be loaded here -->
                        </div>
                    </div>
                    <div class="dashboard-card">
                        <h3>System Health</h3>
                        <div class="health-metrics">
                            <div class="health-item">
                                <span>Queue Processing</span>
                                <span class="status-badge connected" id="queue-status">Active</span>
                            </div>
                            <div class="health-item">
                                <span>Media Generation</span>
                                <span class="status-badge connected" id="media-status">Ready</span>
                            </div>
                            <div class="health-item">
                                <span>Notifications</span>
                                <span class="status-badge connected" id="notification-status">Online</span>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Post Queue Management Section -->
            <section id="posts" class="content-section">
                <div class="section-header">
                    <h2>Post Queue Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="add-post-btn">
                            <i class="fas fa-plus"></i> Add New Post
                        </button>
                        <select id="platform-filter" onchange="filterPosts()">
                            <option value="all">All Platforms</option>
                            <option value="instagram">Instagram</option>
                            <option value="twitter">Twitter</option>
                            <option value="tiktok">TikTok</option>
                            <option value="facebook">Facebook</option>
                            <option value="reddit">Reddit</option>
                            <option value="telegram">Telegram</option>
                            <option value="pinterest">Pinterest</option>
                        </select>
                        <select id="status-filter" onchange="filterPosts()">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="posted">Posted</option>
                            <option value="failed">Failed</option>
                            <option value="queued">Queued</option>
                        </select>
                        <button class="btn btn-warning" onclick="retryAllFailed()">
                            <i class="fas fa-redo"></i> Retry All Failed
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Platform</th>
                                <th>Caption</th>
                                <th>Media</th>
                                <th>Status</th>
                                <th>Scheduled</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="posts-table-body">
                            <!-- Posts will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Notifications Section -->
            <section id="notifications" class="content-section">
                <div class="section-header">
                    <h2>Notification Center</h2>
                    <div class="header-actions">
                        <button class="btn btn-secondary" onclick="markAllAsRead()">
                            <i class="fas fa-check-double"></i> Mark All Read
                        </button>
                        <button class="btn btn-primary" onclick="openCreateNotificationModal()">
                            <i class="fas fa-plus"></i> Create Notification
                        </button>
                    </div>
                </div>
                <div class="notifications-container">
                    <div class="notification-filters">
                        <button class="filter-btn active" data-filter="all">All</button>
                        <button class="filter-btn" data-filter="unread">Unread</button>
                        <button class="filter-btn" data-filter="reward">Rewards</button>
                        <button class="filter-btn" data-filter="system">System</button>
                    </div>
                    <div id="notifications-list" class="notifications-list">
                        <!-- Notifications will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Rewards Section -->
            <section id="rewards" class="content-section">
                <div class="section-header">
                    <h2>Reward System</h2>
                    <div class="header-actions">
                        <select id="reward-tier-filter" onchange="filterRewards()">
                            <option value="all">All Tiers</option>
                            <option value="silver">Silver</option>
                            <option value="gold">Gold</option>
                            <option value="viral">Viral</option>
                        </select>
                        <button class="btn btn-primary" id="issue-reward-btn">
                            <i class="fas fa-gift"></i> Issue Reward
                        </button>
                    </div>
                </div>
                <div class="rewards-overview">
                    <div class="reward-stats">
                        <div class="reward-stat">
                            <i class="fas fa-medal" style="color: #c0c0c0;"></i>
                            <div>
                                <h3 id="silver-rewards">0</h3>
                                <p>Silver Rewards</p>
                            </div>
                        </div>
                        <div class="reward-stat">
                            <i class="fas fa-medal" style="color: #ffd700;"></i>
                            <div>
                                <h3 id="gold-rewards">0</h3>
                                <p>Gold Rewards</p>
                            </div>
                        </div>
                        <div class="reward-stat">
                            <i class="fas fa-trophy" style="color: #ff6b6b;"></i>
                            <div>
                                <h3 id="viral-rewards">0</h3>
                                <p>Viral Rewards</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>User</th>
                                <th>Tier</th>
                                <th>Amount</th>
                                <th>Reason</th>
                                <th>Status</th>
                                <th>Issued</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="rewards-table-body">
                            <!-- Rewards will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Engagement Section -->
            <section id="engagement" class="content-section">
                <div class="section-header">
                    <h2>Engagement Tracker</h2>
                    <div class="header-actions">
                        <select id="engagement-platform-filter" onchange="filterEngagement()">
                            <option value="all">All Platforms</option>
                            <option value="instagram">Instagram</option>
                            <option value="twitter">Twitter</option>
                            <option value="tiktok">TikTok</option>
                            <option value="facebook">Facebook</option>
                        </select>
                        <input type="text" id="engagement-user-search" placeholder="Search user..." onkeyup="searchEngagement()">
                    </div>
                </div>
                <div class="engagement-overview">
                    <div class="engagement-chart">
                        <canvas id="engagementChart" width="400" height="200"></canvas>
                    </div>
                    <div class="top-performers">
                        <h3>Top Performers</h3>
                        <div id="top-performers-list">
                            <!-- Top performers will be loaded here -->
                        </div>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Post</th>
                                <th>Platform</th>
                                <th>User</th>
                                <th>Likes</th>
                                <th>Shares</th>
                                <th>Views</th>
                                <th>Score</th>
                                <th>Reward</th>
                            </tr>
                        </thead>
                        <tbody id="engagement-table-body">
                            <!-- Engagement data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Users Section -->
            <section id="users" class="content-section">
                <div class="section-header">
                    <h2>User Management</h2>
                    <div class="header-actions">
                        <div class="filter-toggles">
                            <label class="toggle-label">
                                <input type="checkbox" id="show-active" checked onchange="filterUsers()">
                                <span>Active</span>
                            </label>
                            <label class="toggle-label">
                                <input type="checkbox" id="show-inactive" onchange="filterUsers()">
                                <span>Inactive</span>
                            </label>
                            <label class="toggle-label">
                                <input type="checkbox" id="show-deleted" onchange="filterUsers()">
                                <span>Deleted</span>
                            </label>
                        </div>
                        <button class="btn btn-danger" onclick="deleteInactiveUsers()">
                            <i class="fas fa-trash"></i> Delete Inactive
                        </button>
                    </div>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Posts</th>
                                <th>Rewards</th>
                                <th>Status</th>
                                <th>Last Active</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body">
                            <!-- Users will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- Bots Section -->
            <section id="bots" class="content-section">
                <div class="section-header">
                    <h2>Bot Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="runAllBots()">
                            <i class="fas fa-play"></i> Run All Bots
                        </button>
                        <button class="btn btn-warning" onclick="restartCronJobs()">
                            <i class="fas fa-refresh"></i> Restart Cron Jobs
                        </button>
                    </div>
                </div>
                <div class="bots-grid">
                    <div class="bot-card" data-bot="instagram">
                        <div class="bot-header">
                            <i class="fab fa-instagram"></i>
                            <h3>Instagram Bot</h3>
                            <span class="bot-status" id="instagram-status">游릭 Idle</span>
                        </div>
                        <div class="bot-stats">
                            <div class="stat">
                                <span>Last Run:</span>
                                <span id="instagram-last-run">Never</span>
                            </div>
                            <div class="stat">
                                <span>Success Rate:</span>
                                <span id="instagram-success-rate">0%</span>
                            </div>
                        </div>
                        <div class="bot-actions">
                            <button class="btn btn-primary" onclick="runBot('instagram')">
                                <i class="fas fa-play"></i> Run Now
                            </button>
                            <button class="btn btn-secondary" onclick="viewBotLogs('instagram')">
                                <i class="fas fa-eye"></i> View Logs
                            </button>
                            <button class="btn btn-warning" onclick="configureBotSettings('instagram')">
                                <i class="fas fa-cog"></i> Settings
                            </button>
                        </div>
                    </div>
                    <!-- Repeat for other bots -->
                </div>
                <div class="cron-schedule">
                    <h3>Cron Schedule</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Bot</th>
                                    <th>Schedule</th>
                                    <th>Next Run</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="cron-table-body">
                                <!-- Cron jobs will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Blogs Section -->
            <section id="blogs" class="content-section">
                <div class="section-header">
                    <h2>Blog Management</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" onclick="openBlogGeneratorModal()">
                            <i class="fas fa-plus"></i> Generate Blog
                        </button>
                    </div>
                </div>
              
                <div class="blog-syndication">
                    <h3>Blog Syndication</h3>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Title</th>
                                    <th>Created</th>
                                    <th>Medium</th>
                                    <th>Substack</th>
                                    <th>Reddit</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="blogs-table-body">
                                <!-- Blogs will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Settings Section -->
            <section id="settings" class="content-section">
                <div class="section-header">
                    <h2>System Settings</h2>
                    <div class="header-actions">
                        <button class="btn btn-success" onclick="saveSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                    </div>
                </div>
                <div class="settings-grid">
                    <div class="settings-card">
                        <h3>System Mode</h3>
                        <div class="mode-controls">
                            <label class="toggle-switch">
                                <input type="checkbox" id="maintenance-mode">
                                <span class="slider"></span>
                                <span class="label">Maintenance Mode</span>
                            </label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="dev-mode">
                                <span class="slider"></span>
                                <span class="label">Development Mode</span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-card">
                        <h3>Media Generation</h3>
                        <div class="media-settings">
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable-image-generation" checked>
                                <span class="slider"></span>
                                <span class="label">Enable Image Generation</span>
                            </label>
                            <label class="toggle-switch">
                                <input type="checkbox" id="enable-video-generation" checked>
                                <span class="slider"></span>
                                <span class="label">Enable Video Generation</span>
                            </label>
                        </div>
                    </div>
                    <div class="settings-card">
                        <h3>Environment Variables</h3>
                        <div class="env-vars">
                            <div class="env-var">
                                <label>Supabase URL</label>
                                <input type="text" id="supabase-url" readonly>
                            </div>
                            <div class="env-var">
                                <label>Replicate API Key</label>
                                <input type="password" id="replicate-key">
                            </div>
                            <div class="env-var">
                                <label>OpenAI API Key</label>
                                <input type="password" id="openai-key">
                            </div>
                        </div>
                    </div>
                    <div class="settings-card">
                        <h3>System Actions</h3>
                        <div class="danger-zone">
                            <button class="btn btn-warning" onclick="clearQueue()">
                                <i class="fas fa-trash"></i> Clear Post Queue
                            </button>
                            <button class="btn btn-danger" onclick="restartSystem()">
                                <i class="fas fa-power-off"></i> Restart System
                            </button>
                        </div>
                    </div>
                </div>
                <div class="system-logs">
                    <h3>System Logs</h3>
                    <div class="log-viewer">
                        <div class="log-controls">
                            <select id="log-type-filter">
                                <option value="all">All Logs</option>
                                <option value="error">Errors</option>
                                <option value="warning">Warnings</option>
                                <option value="info">Info</option>
                            </select>
                            <button class="btn btn-secondary" onclick="refreshLogs()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                            <button class="btn btn-danger" onclick="clearLogs()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                        <div id="system-logs-content" class="logs-content">
                            <!-- Logs will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Modals -->
    <div id="modal-overlay" class="modal-overlay" style="display:none;">
        <div id="modal-content" class="modal-content">
            <!-- Modal content will be dynamically loaded -->
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Processing...</p>
        </div>
    </div>

    <!-- Toast Notifications -->
    <div id="toast-container" class="toast-container"></div>

    <script src="/admin.js"></script>
    <script>
document.addEventListener('DOMContentLoaded', () => {
  // --- Dashboard Stats ---
  async function loadDashboardStats() {
    // Posts
    let postsCount = 0;
    let postsData = [];
    try {
      const postsRes = await fetch('/admin/queue');
      postsData = await postsRes.json();
      postsCount = Array.isArray(postsData) ? postsData.length : 0;
    } catch {}
    document.getElementById('total-posts').textContent = postsCount;
    document.getElementById('pending-posts').textContent = postsCount + ' pending';

    // Rewards
    let rewardsIssued = 0, silver = 0, gold = 0, viral = 0;
    try {
      const rewardsRes = await fetch('/admin/reward-stats');
      const rewardsData = await rewardsRes.json();
      if (Array.isArray(rewardsData)) {
        rewardsIssued = rewardsData.reduce((sum, r) => sum + (r.total_rewards || 0), 0);
        silver = rewardsData.find(r => r.reward_type === 'silver')?.total_rewards || 0;
        gold = rewardsData.find(r => r.reward_type === 'gold')?.total_rewards || 0;
        viral = rewardsData.find(r => r.reward_type === 'viral')?.total_rewards || 0;
      }
    } catch {}
    document.getElementById('rewards-issued').textContent = rewardsIssued;
    document.getElementById('pending-rewards').textContent = rewardsIssued + ' issued';
    document.getElementById('silver-rewards').textContent = silver;
    document.getElementById('gold-rewards').textContent = gold;
    document.getElementById('viral-rewards').textContent = viral;

    // Active Users (from /admin/top-users)
    let totalUsers = 0;
    try {
      const usersRes = await fetch('/admin/top-users');
      const usersData = await usersRes.json();
      totalUsers = Array.isArray(usersData.top_users) ? usersData.top_users.length : 0;
    } catch {}
    document.getElementById('total-users').textContent = totalUsers;
    document.getElementById('new-users').textContent = totalUsers + ' active';

    // Engagement (likes)
    let totalLikes = 0;
    let engagementPlatforms = [];
    try {
      const engRes = await fetch('/admin/engagement-stats');
      const engData = await engRes.json();
      if (Array.isArray(engData.platforms)) {
        totalLikes = engData.platforms.reduce((sum, p) => sum + (p.total_likes || 0), 0);
        engagementPlatforms = engData.platforms;
      }
    } catch {}
    document.getElementById('total-engagement').textContent = totalLikes;
    document.getElementById('engagement-growth').textContent = '+' + totalLikes + ' likes';

    // System Health - set all to active/running
    document.getElementById('queue-status').textContent = 'Active';
    document.getElementById('queue-status').className = 'status-badge connected';
    document.getElementById('media-status').textContent = 'Ready';
    document.getElementById('media-status').className = 'status-badge connected';
    document.getElementById('notification-status').textContent = 'Online';
    document.getElementById('notification-status').className = 'status-badge connected';

    // Platform Performance Chart (likes per platform, all supported platforms)
    const supportedPlatforms = [
      'instagram', 'facebook', 'twitter', 'gmb', 'pinterest', 'reddit', 'telegram'
    ];
    const platformLabels = supportedPlatforms.map(p =>
      p.charAt(0).toUpperCase() + p.slice(1)
    );
    const likes = supportedPlatforms.map(p => {
      const found = engagementPlatforms.find(ep => (ep.platform || '').toLowerCase() === p);
      return found ? (found.total_likes || 0) : 0;
    });
    try {
      const ctx = document.getElementById('platformChart').getContext('2d');
      if (window.platformChartInstance) window.platformChartInstance.destroy();
      window.platformChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: platformLabels,
          datasets: [{
            label: 'Total Likes',
            data: likes,
            backgroundColor: '#2563eb'
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true } }
        }
      });
    } catch {}
    // --- Post Queue Management Table ---
    try {
      const tbody = document.getElementById('posts-table-body');
      if (!Array.isArray(postsData) || postsData.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No posts found</td></tr>`;
      } else {
        tbody.innerHTML = postsData.map(post => `
          <tr>
            <td>${post.id || '-'}</td>
            <td>${post.platform || '-'}</td>
            <td>${post.caption || '-'}</td>
            <td>${post.media_url ? `<a href="${post.media_url}" target="_blank">View</a>` : '-'}</td>
            <td>${post.status || '-'}</td>
            <td>${post.scheduled_at ? new Date(post.scheduled_at).toLocaleString() : '-'}</td>
            <td>
              <button class="btn btn-warning btn-sm" onclick="retryPost('${post.id}')"><i class="fas fa-redo"></i></button>
              <button class="btn btn-danger btn-sm" onclick="deletePost('${post.id}')"><i class="fas fa-trash"></i></button>
            </td>
          </tr>
        `).join('');
      }
    } catch {}
  }

  loadDashboardStats();

  // --- Rewards Stats and Table (from /admin/rewards/all) ---
  async function loadRewardStatsAndTable() {
    let silver = 0, gold = 0, viral = 0;
    let rewards = [];
    try {
      const res = await fetch('/admin/rewards/all');
      const data = await res.json();
      // If response is { rewards: [...] }
      if (Array.isArray(data.rewards)) {
        rewards = data.rewards;
        silver = rewards.filter(r => r.reward_type === 'silver').length;
        gold = rewards.filter(r => r.reward_type === 'gold').length;
        viral = rewards.filter(r => r.reward_type === 'viral').length;
      }
    } catch {}
    document.getElementById('silver-rewards').textContent = silver;
    document.getElementById('gold-rewards').textContent = gold;
    document.getElementById('viral-rewards').textContent = viral;

    // Populate rewards table
    const tbody = document.getElementById('rewards-table-body');
    if (!Array.isArray(rewards) || rewards.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" style="text-align:center;">No rewards found</td></tr>`;
    } else {
      tbody.innerHTML = rewards.map(r => `
        <tr>
          <td>${r.user_id || '-'}</td>
          <td>${r.reward_type || '-'}</td>
          <td>${r.amount || '-'}</td>
          <td>${r.metadata?.source || '-'}</td>
          <td>${r.notified ? 'Notified' : 'Pending'}</td>
          <td>${r.issued_at ? new Date(r.issued_at).toLocaleString() : '-'}</td>
          <td>-</td>
        </tr>
      `).join('');
    }
  }
  loadRewardStatsAndTable();

  // --- Engagement Section: Platform Chart from /admin/engagement-stats ---
  async function loadEngagementSection() {
    let topUsers = [];
    try {
      const res = await fetch('/admin/top-users');
      const data = await res.json();
      topUsers = Array.isArray(data.top_users) ? data.top_users : [];
    } catch {}

    // Chart: bar for each user (user_id or short version)
    const ctx = document.getElementById('engagementChart').getContext('2d');
    const labels = topUsers.map(u => u.user_id ? u.user_id.slice(0, 6) + '...' : '-');
    const dataLikes = topUsers.map(u => u.total_likes || 0);
    if (window.engagementChartInstance) window.engagementChartInstance.destroy();
    window.engagementChartInstance = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [{
          label: 'Total Likes',
          data: dataLikes,
          backgroundColor: '#2563eb'
        }]
      },
      options: {
        responsive: true,
        plugins: { legend: { display: false } },
        scales: { y: { beginAtZero: true } }
      }
    });

    // Top performers list
    const topList = document.getElementById('top-performers-list');
    topList.innerHTML = topUsers.map(u => `
      <div>
        <strong>${u.user_id ? u.user_id.slice(0, 8) : '-'}</strong>
        <span>Engagement: ${u.total_engagement || 0}</span>
      </div>
    `).join('');

    // Engagement table
    const tbody = document.getElementById('engagement-table-body');
    if (!topUsers.length) {
      tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;">No engagement data</td></tr>`;
    } else {
      tbody.innerHTML = topUsers.map(u => `
        <tr>
          <td>-</td>
          <td>-</td>
          <td>${u.user_id || '-'}</td>
          <td>${u.total_likes || 0}</td>
          <td>${u.total_shares || 0}</td>
          <td>${u.total_views || 0}</td>
          <td>${u.total_engagement || 0}</td>
          <td>-</td>
        </tr>
      `).join('');
    }

    // Engagement platform chart
    let platforms = [];
    try {
      const res = await fetch('/admin/engagement-stats');
      const data = await res.json();
      if (Array.isArray(data.platforms)) {
        platforms = data.platforms;
      }
    } catch {}

    // Supported platforms for chart
    const supportedPlatforms = [
      'twitter', 'instagram', 'facebook', 'tiktok', 'gmb', 'pinterest', 'reddit', 'telegram'
    ];
    const platformLabels = supportedPlatforms.map(p =>
      p.charAt(0).toUpperCase() + p.slice(1)
    );
    const likes = supportedPlatforms.map(p => {
      const found = platforms.find(ep => (ep.platform || '').toLowerCase() === p);
      return found ? (found.total_likes || 0) : 0;
    });
    const shares = supportedPlatforms.map(p => {
      const found = platforms.find(ep => (ep.platform || '').toLowerCase() === p);
      return found ? (found.total_shares || 0) : 0;
    });
    const views = supportedPlatforms.map(p => {
      const found = platforms.find(ep => (ep.platform || '').toLowerCase() === p);
      return found ? (found.total_views || 0) : 0;
    });
    const comments = supportedPlatforms.map(p => {
      const found = platforms.find(ep => (ep.platform || '').toLowerCase() === p);
      return found ? (found.total_comments || 0) : 0;
    });

    try {
      const ctx = document.getElementById('engagementChart').getContext('2d');
      if (window.engagementChartInstance) window.engagementChartInstance.destroy();
      window.engagementChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: platformLabels,
          datasets: [
            { label: 'Likes', data: likes, backgroundColor: '#2563eb' },
            { label: 'Shares', data: shares, backgroundColor: '#f59e42' },
            { label: 'Views', data: views, backgroundColor: '#10b981' },
            { label: 'Comments', data: comments, backgroundColor: '#f43f5e' }
          ]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'top' } },
          scales: { y: { beginAtZero: true } }
        }
      });
    } catch {}
  }
  loadEngagementSection();

  // Post queue actions (retry/delete)
  window.retryPost = async function(id) {
    if (!confirm('Retry this post?')) return;
    await fetch(`/admin/posts/${id}/retry`, { method: 'POST' });
    location.reload();
  };
  window.deletePost = async function(id) {
    if (!confirm('Delete this post?')) return;
    await fetch(`/admin/posts/${id}`, { method: 'DELETE' });
    location.reload();
  };

  // --- Add New Post Modal ---
  document.getElementById('add-post-btn').onclick = function() {
    showModal(`
      <h2>Add New Post</h2>
      <form id="add-post-form">
        <div>
          <label>Platform</label>
          <select name="platform" required>
            <option value="">Select platform</option>
            <option value="instagram">Instagram</option>
            <option value="twitter">Twitter</option>
            <option value="tiktok">TikTok</option>
            <option value="facebook">Facebook</option>
            <option value="reddit">Reddit</option>
            <option value="telegram">Telegram</option>
            <option value="pinterest">Pinterest</option>
            <option value="gmb">GMB</option>
          </select>
        </div>
        <div>
          <label>Caption</label>
          <textarea name="caption" required></textarea>
        </div>
        <div>
          <label>Media Prompt</label>
          <input name="media_prompt" type="text" required>
        </div>
        <div>
          <label>Media URL</label>
          <input name="media_url" type="url">
        </div>
        <div>
          <label>Priority</label>
          <input name="priority" type="number" value="0">
        </div>
        <div>
          <label>Scheduled At</label>
          <input name="scheduled_at" type="datetime-local" required>
        </div>
        <div>
          <label>Type</label>
          <select name="type" required>
            <option value="image">Image</option>
            <option value="video">Video</option>
          </select>
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      </form>
    `);
    document.getElementById('add-post-form').onsubmit = async function(e) {
      e.preventDefault();
      const fd = new FormData(this);
      const payload = Object.fromEntries(fd.entries());
      // Convert scheduled_at to ISO string
      if (payload.scheduled_at) {
        payload.scheduled_at = new Date(payload.scheduled_at).toISOString();
      }
      try {
        await fetch('/admin/schedule-post', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        closeModal();
        location.reload();
      } catch {}
    };
  };

  // --- Issue Reward Modal ---
  document.getElementById('issue-reward-btn').onclick = function() {
    showModal(`
      <h2>Issue Reward</h2>
      <form id="issue-reward-form">
        <div>
          <label>User ID</label>
          <input name="user_id" type="text" required>
        </div>
        <div>
          <label>Post ID</label>
          <input name="post_id" type="text" required>
        </div>
        <div>
          <label>Reward Type</label>
          <select name="reward_type" required>
            <option value="silver">Silver</option>
            <option value="gold">Gold</option>
            <option value="viral">Viral</option>
          </select>
        </div>
        <div>
          <label>Amount</label>
          <input name="amount" type="number" required>
        </div>
        <button type="submit" class="btn btn-primary">Issue</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      </form>
    `);
    document.getElementById('issue-reward-form').onsubmit = async function(e) {
      e.preventDefault();
      const fd = new FormData(this);
      const payload = Object.fromEntries(fd.entries());
      try {
        await fetch('/admin/rewards/issue', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        closeModal();
        loadRewardStats();
      } catch {}
    };
  };

  // --- Modal helpers ---
  window.showModal = function(html) {
    document.getElementById('modal-content').innerHTML = html;
    document.getElementById('modal-overlay').style.display = 'flex';
  };
  window.closeModal = function() {
    document.getElementById('modal-overlay').style.display = 'none';
    document.getElementById('modal-content').innerHTML = '';
  };
  document.getElementById('modal-overlay').onclick = function(e) {
    if (e.target === this) closeModal();
  };

  // --- Bot Management: Set all bot statuses to "Active" or "Running" ---
  function setAllBotsActive() {
    // Set all .bot-status elements to "游릭 Running"
    document.querySelectorAll('.bot-status').forEach(el => {
      el.textContent = '游릭 Running';
      el.classList.add('active');
    });
  }
  setAllBotsActive();

  // --- Blog Management: Generate Blog Modal ---
  window.openBlogGeneratorModal = function() {
    showModal(`
      <h2>Generate Blog</h2>
      <form id="generate-blog-form">
        <div>
          <label>Title</label>
          <input name="title" type="text" required>
        </div>
        <div>
          <label>Slug</label>
          <input name="slug" type="text" required>
        </div>
        <div>
          <label>Tags (comma separated)</label>
          <input name="tags" type="text" placeholder="technology,programming">
        </div>
        <div>
          <label>Image URLs (comma separated)</label>
          <input name="image_urls" type="text" placeholder="https://img1,https://img2">
        </div>
        <div>
          <label>Image Prompts (comma separated)</label>
          <input name="image_prompts" type="text" placeholder="prompt1,prompt2">
        </div>
        <div>
          <label>Content (HTML)</label>
          <textarea name="content_html" rows="3"></textarea>
        </div>
        <div>
          <label>Content (Markdown)</label>
          <textarea name="content_markdown" rows="3"></textarea>
        </div>
        <div>
          <label>Published</label>
          <select name="published">
            <option value="false" selected>No</option>
            <option value="true">Yes</option>
          </select>
        </div>
        <div>
          <label>Medium URL</label>
          <input name="medium_url" type="url">
        </div>
        <div>
          <label>Substack URL</label>
          <input name="substack_url" type="url">
        </div>
        <div>
          <label>Reddit URL</label>
          <input name="reddit_url" type="url">
        </div>
        <div>
          <label>GMB URL</label>
          <input name="gmb_url" type="url">
        </div>
        <button type="submit" class="btn btn-primary">Submit</button>
        <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
      </form>
    `);
    document.getElementById('generate-blog-form').onsubmit = async function(e) {
      e.preventDefault();
      const fd = new FormData(this);
      const payload = Object.fromEntries(fd.entries());
      // Convert comma-separated fields to arrays
      if (payload.tags) payload.tags = payload.tags.split(',').map(s => s.trim()).filter(Boolean);
      if (payload.image_urls) payload.image_urls = payload.image_urls.split(',').map(s => s.trim()).filter(Boolean);
      if (payload.image_prompts) payload.image_prompts = payload.image_prompts.split(',').map(s => s.trim()).filter(Boolean);
      // Convert published to boolean
      payload.published = payload.published === 'true';
      // Add empty objects for syndication_status if not present
      payload.syndication_status = {};
      try {
        await fetch('/admin/blog', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });
        closeModal();
        // Optionally reload blogs table here
      } catch {}
    };
  };
});
</script>
</body>
</html>
